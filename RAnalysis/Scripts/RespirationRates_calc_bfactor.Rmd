---
title: "RespirationRates_calc_F1s"
author: "Samuel Gurr"
date: "11/29/2022"
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
---


```{r setup, include=FALSE}

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::
library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(kableExtra)
library(pander)
library(data.table)
library(stringr)
library(latex2exp)
library(Rmisc)
library(devtools)
library(ggpubr)
# library(hrbrthemes)

# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis")
#knitr::opts_knit$set(root.dir = "C:/Users/samuel.gurr/Documents/Github_repositories/EAD-ASEB-Airradians_multigen_OA/RAnalysis")


```


```{r, load data}

# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::
# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # personal computer
# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # Work computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
resp.data           <- read.csv(file="Output/Respiration/RR_LoLin_raw.csv", header=T) %>% 
                          dplyr::filter(!(Date %in% "9/14/2021" & 
                                          Filename %in% 'Run_1_raw.txt')) %>%  # read the calculate raw rates from 'resp_LoLin' script - contains the calculated rate (not normalized for blanks) for each sensor-channel
                          dplyr::filter(!(Date %in% "10/26/2022" &
                                            Filename %in% 'run_1_raw.txt' & Channel %in% 'CH2')) %>%  # omit bad data point
                          dplyr::filter(!(Date %in% c("3/16/2023", # larvae from full reciprocal trial with F2s - analyzed separately in RespirationRates_calc_larvae
                                                     "4/7/2023",  # larvae from full reciprocal trial with F3s - analyzed separately in RespirationRates_calc_larvae 
                                                     "4/12/2023")))# larvae from full reciprocal trial with F3s - analyzed separately in RespirationRates_calc_larvae
                          



start.end_resp.data <- read.csv(file="Output/Respiration/RR_start_end_raw.csv", header=T, sep = "") #%>% 
                          #dplyr::filter(!Date %in% "9/14/2021" | !Filename %in% 'Run_1_raw.txt') # read the start and end simplified resp data

resp.ref            <- read.csv(file="Data/Physiology/Respiration/metadata/Reference_resp_ID.csv", header=T) %>% 
                           dplyr::filter(!Date %in% "9/14/2021" | !Filename %in% 'Run_1_raw.txt') 


# data to correct for length, dry weight, etc. 
lengths_juv_adults  <- read.csv(file="Data/Physiology/Respiration/metadata/Reference_resp_size.csv", header=T)

lengths_spat        <- read.csv(file="Data/Physiology/Respiration/metadata/Reference_resp_size_LARVAE.csv", header=T) %>% 
                          dplyr::mutate(Length_um = Length * 1000) %>% # current length in mm
                          dplyr::select(!Length)
# View(resp.data)

```

### Merge master resp data frame with lengths

```{r merge resp with length data and treatment IDs, echo=FALSE}

# lengths_spat contains early development resp runs
# as multiple individuals per well (in some cases!) 
# whereas 'lengths' is for juvenile-adult stage scallops each as one length for each resp value 
# thus, we need to summarise as a mean for the 'lengths_spat' file before merging with the other file
head(lengths_juv_adults) # here are the juveniles and adults - a single length individual for each resp channel
head(lengths_spat) # take a look at it here, you see muliple entries for a single well for the larvae/spat resp runs
lengths_spat_MEAN <- as.data.frame(lengths_spat %>% 
                      dplyr::group_by(Date,Run,Plate,Channel, Chamber_tank,Number,pH) %>% 
                      dplyr::summarise(Length_um = mean(Length_um))) %>% # group and summarise as a mean
                      dplyr::select(!Channel)
lenghts_master <- rbind.fill(lengths_juv_adults, lengths_spat_MEAN) # use rbind.fill to merge including NAs for missing columns

# check the data - ensure all data was run
if(nrow(resp.data) == nrow(start.end_resp.data)){ # MUST be TRUE
resp_all_raw <- merge(resp.data, start.end_resp.data)
} else{resp_all_raw <- resp.data}

# merge the exp_metadata with the resp.data
resp.ref_length_merged                 <- merge(resp.ref, 
                                                lenghts_master) # all TRUE allows us to keep the blanks

resp.data_merged                       <- merge(resp.data, resp.ref_length_merged) %>% 
                                            dplyr::mutate(filetype = str_sub(Filename, -3,-1)) %>% 
                                            dplyr::mutate(filetype = factor(ifelse(filetype == "csv", 
                                                                                   "SDR_data", 
                                                                                   "LoLigo_data"))) %>% 
                                            dplyr::mutate(Date_formatted =  gsub("-", "", substr( (strptime(Date, "%m/%d/%Y")), 1,10)) ) %>% 
                                            dplyr::arrange(Date_formatted,Run, Channel, .by_group = TRUE)
kable(head(resp.data_merged))
unique(resp.data_merged$Date)
# View(resp.data_merged)
```

#### Visual diagnostic plots to correct poor data (3 data points to change..)

- View on github: Airradians_OA/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/

- found three calls that inaccurately represent the rates of oxygen consumption 

(1) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_2_C5_regression.pdf
- solution = call 'Lz' instead of the default Leq

(2) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_2_Run_1_C1_regression.pdf
- solution = call 'Lz' instead of the default Leq

(3) https://github.com/SamGurr/Airradians_OA/blob/master/RAnalysis/Output/Respiration/plots_alpha0.4_increm15sec/20210930_Plate_1_Run_2_C1_regression.pdf
- solution = we reran this at the end of the LoLin script  for 0-20 minutes and got an Lpc  -0.0296, insert this 

```{r IMPORTANT correct poor data, echo=TRUE, message = FALSE, warning = FALSE}

# NOTE: the F2s have a late start in resp value in 2/23/2023 run 2 channel 6 - scllop did not open until late in trial and ended same time as others - we discussed omission

resp.data_merged[47,c(1:6)]  # 	C1 RR_9.30.21_AM_Plate_2_Run_1.csv # -0.02890813	-0.0608251	-0.0608251 - Lz and Leq call better regression than Lp5resp.data_merged[124,c(1:6)] 
resp.data_merged[90,c(1:6)]  #  C5 RR_9.30.21_PM_Plate_2_Run_2.csv	0.029052351	-0.076034441	-0.076034441
resp.data_merged[84,c(1:6)]  # 	C1 RR_9.30.21_PM_Plate_1_Run_2.csv	0.011656487	0.011656487	0.011656487  - ommit this
resp.data_merged[135,c(1:6)] # 	2/2/2022	CH1	run_1_raw.txt  -0.03291728	-0.02714124	-0.0271412; data change Lpc to -0.0209
resp.data_merged[148,c(1:6)] # 	2/2/2022	CH2	run_3_raw.txt	-0.004996976	-0.007234043	-0.007234043; data change Lpc to -0.0124
resp.data_merged[257,c(1:6)] #  10/26/2022	CH3	run_2_raw.txt	0.04303898	-0.0047484	-0.0047484; data change Lpc to -0.1063
resp.data_merged[258,c(1:6)] #  10/26/2022	CH4	run_2_raw.txt	-0.003937913	-0.003744103	-0.003744103; data change Lpc to -0.0900
resp.data_merged[261,c(1:6)] #  10/26/2022	CH7	run_2_raw.txt	-0.002582753	-0.004017686	-0.004017686; data change Lpc to -0.1012

# change according to diagnostics of plots and in Lolin script 
resp.data_merged[47,4] <- resp.data_merged[47,5] # 20210930_Plate_2_Run_2_C5_regression - Lz and Leq call better regression than Lpc
resp.data_merged[90,4] <- resp.data_merged[90,5] # 20210930_Plate_2_Run_1_C1_regression - Lz and Leq call better regression than Lpc
resp.data_merged[84,4] <- -0.0296 # 20210930_Plate_1_Run_2_C1_regression - plot shows noise after the 20 minutes mark, we reran this at the end of the LoLin script, insert here!
resp.data_merged[135,4] <- -0.0209
resp.data_merged[148,4] <- -0.0124
resp.data_merged[257,4] <- -0.1063
resp.data_merged[258,4] <- -0.0900
resp.data_merged[261,4] <- -0.1012

# double check if correct
resp.data_merged[47,c(1:6)] # -0.0608251
resp.data_merged[90,c(1:6)] # -0.07603444
resp.data_merged[84,c(1:6)] # -0.0296
resp.data_merged[135,c(1:6)]  # -0.0209
resp.data_merged[148,c(1:6)]  # -0.0124
resp.data_merged[257,c(1:6)]  # -0.1063
resp.data_merged[258,c(1:6)]  # -0.09
resp.data_merged[261,c(1:6)]  # -0.1012
```

#### Calculate blank rates, view means by day pH_treatment and instrument

* note: respiration rates were recorded using both SDR dish (24 channel) and Loligo 8-channel sensors - different blanks for each

```{r call blanks, echo=FALSE}



blanks_total <- data.frame() # start dataframe 
blanks.table <- data.frame(matrix(nrow = 1,ncol = 5)) # make a table template
colnames(blanks.table)<-c('Date', 'Channel', 'mean_Lpc', 'mean_Leq' , 'mean_Lz') # names for comuns in the for loop

blanks_all_raw <- data.frame(merge(resp.data, resp.ref)) %>% # data.frame((merge(resp_all_raw, resp.ref)) %>%
                  dplyr::mutate(filetype = str_sub(Filename, -3,-1)) %>% 
                  dplyr::mutate(filetype = factor(ifelse(filetype == "csv", "SDR_data", "LoLigo_data"))) %>% 
                  dplyr::filter(Chamber_tank  == 'blank') %>% 
                  #dplyr::filter(Lpc <0) %>% 
                  dplyr::filter(!Date == '9/30/2021' | !Lpc < -0.035) %>% #omits C6 RR_9.30.21_AM_Plate_1_Run_1.csv	8.0	blank - View the Lolin plot, looks noisy and a fast outlier from the others
                  dplyr::filter(!Date ==  '9/30/2021'   | !pH == "7.5" | !Channel == "B2" | !Run == "1" | !Plate == "1" ) %>% # abnormal high rate for a blank - omission approximates the mean blank for the other treatment (bad data)
                  dplyr::filter(!Date == '8/30/2022' | !Lpc < -0.02) %>% # omit the few outlier blanks shiting rates higher than those with spat or larvae
                  dplyr::filter(!Date == '10/26/2021'  | !Channel == "CH8" | !Run == "2" ) %>% # omit a bad blank that contained a bad seal, noted on the respiration sampling day during the trial 
                  dplyr::select(c('Date', 'Run', 'Channel','Filename','pH','Lpc', 'Leq', 'Lz','filetype')) %>% # add 'Rate_mgO2_hour'hen the start and end is completed
                  dplyr::arrange(Date,pH, .by_group = TRUE)

# View(blanks_all_raw)


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# mean blanks for the LoLinR output ('Lpc') ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

blanks_all_raw %>% 
  select(Lpc) %>% 
  dplyr::mutate(Lpc_filt = case_when(Lpc > 0 & Lpc < 0.005 ~ 0,TRUE ~ Lpc))# fed F1 foodxOA

blanks_meansLoLin <- blanks_all_raw %>% 
                       dplyr::group_by(Date, pH, Run, filetype) %>% # grouped by date, pH, and instrument - similar among Run
                       #dplyr::filter(Lpc <0) %>% # ommit blank calls that d/n represent oxygen consumption
                       dplyr::mutate(Lpc_filt = case_when(Lpc > 0 & Lpc < 0.005 ~ 0,TRUE ~ Lpc)) %>% #  when LPC is positive but veery close to zero - assign as zero
                       dplyr::summarise(BLANK.mean_Lpc = mean(abs(Lpc_filt)),
                                        #   = sd(abs(Lpc)),
                                        # BLANK.mean_Leq = mean(abs(Leq)), 
                                        # BLANK.mean_Lz  = mean(abs(Lz)),
                                        n = n()) %>% 
                        dplyr::mutate(Date_formatted =  gsub("-", "", substr( (strptime(Date, "%m/%d/%Y")), 1,10)) ) %>% 
                        dplyr::arrange(Date_formatted, Run, pH)
# kable(blanks_meansLoLin) # View - notice some of the date/runs do not have BOTH treatments represented!
dups_LoLin        <- blanks_meansLoLin[(17),] %>% #one rows that does have each treatment  represented (due to positive rates, bad data, etc)         
                        dplyr::mutate(pH = ifelse(pH == 8.0, 7.5,  ifelse(pH == 7.5, 8.0, NA))) # do a little conditional call to call the opposite treatment in this dataframe..
blanks_meansLoLin <- rbind(blanks_meansLoLin, dups_LoLin) %>%  dplyr::arrange(Date_formatted, Run, pH) # bind together




# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# mean blanks for the start - to - end values ('Rate_mgO2_hour') :::::::::::::::::::::::::::::::::::::::::




# blanks_meansStartEnd <- blanks_all_raw %>% 
#                          dplyr::group_by(Date, pH, Run, filetype) %>% # grouped by date, pH, and instrument - similar among Runs
#                          dplyr::filter(!Rate_mgO2_hour < 0) %>% # ommit blank calls that d/n represent oxygen consumption
#                          dplyr::summarise(BLANK.start.end_mean  = mean(Rate_mgO2_hour),
#                                           # BLANK.start.end_sd  = sd(Rate_mgO2_hour),
#                                           n = n()) %>% 
#                           dplyr::mutate(Date_formatted =  gsub("-", "", substr( (strptime(Date, "%m/%d/%Y")), 1,10)) ) %>% 
#                           dplyr::arrange(Date_formatted, Run, pH)
# # kable(blanks_meansStartEnd) # View - notice some of the date/runs combos do not have BOTH treatmentents represented!
# dups_StartEnd          <- blanks_meansStartEnd[c(1, 16,19,28),] %>% # call the rows that do not have BOTH pH 7.5 and 8.0 represented (due to positive rates, bad data, etc)    
#                           dplyr::mutate(pH = ifelse(pH == 8.0, 7.5,  ifelse(pH == 7.5, 8.0, NA))) # do a little conditional call to call the opposite treatment dataframe..
# blanks_meansStartEnd   <- rbind(blanks_meansStartEnd, dups_StartEnd) %>%  dplyr::arrange(Date_formatted, Run, pH)
# 




# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# merge blanks Lolin rates and blanks for start-end rates ::::::::::::::::::::::::::::::::::::::::::::::::

#... first and foremost! do not do this if rate calculations differ in row size 
# (not all data ran for Lolin and star end resp)


if(nrow(resp.data) == nrow(start.end_resp.data)){ # if they are the same length (all data ran for both analysis)
blanks_means <- merge(blanks_meansLoLin, blanks_meansStartEnd) %>% dplyr::arrange(Date_formatted, Run, pH) # merge blanks
} else{blanks_means <- blanks_meansLoLin} # else we focus only on the blanks for the LoLin rate (what we will use) 



# lets take a look at our mean blank values! :::::::::::::::::::::::::::::::::::::::::::::::::::::


kable(blanks_means) # View the inserted duplicates for the other treatment on same run/date

# NOTe: 10/26/22 has wide differences between blank rates
```

#### Merge blanks with the master file by Date, pCO2 treatment, and filetype

* 'filteype' is only important here on 20211026 when both Loligo and SDR were used due to difference in size for fed (larger) and unfed animals 

```{r merge blanks_means for a master file, echo=FALSE}

Resp.Master <- merge(resp.data_merged, blanks_means, by=c("Date", "pH", "Run", "filetype")) %>% # NOTE: this repeats for every distinct length value
  dplyr::filter(!Lpc > 0) %>% # remove values with positive O2 - should be none here, double check by removing the '!' and run partial pipeline (found 9/14/2021	pH 8	LoLigo_data	CH1)
  dplyr::mutate(resp_blankStand = (abs(Lpc)) - BLANK.mean_Lpc) # %>%  # Lpc =  Lolin calculated resp (used for SMR actual rates), raw value is negative, take the absolute value and subtract from the mean blank Lpc (already abs value)
 # dplyr::mutate(start.end_resp_blankStand = Rate_mgO2_hour - BLANK.start.end_mean) # just start and end (simplified rate in mg O2 per hour) for O:N comparisons

#plot(Resp.Master$start.end_resp_blankStand, Resp.Master$resp_blankStand)

```


## Master Resp file 'Resp.Master_OM', with volumes and file types, etc. saved as 'Calculated_Resp_Master.csv'

######  dplyr::mutate for the following:

* 'volume' of the different vessels throughout the fed*OA challenge
* 'Age'
* 'Fed_unfed'
* 'pCO2'

```{r master resp file, echo=FALSE}
# View(Resp.Master[!is.na(Resp.Master$Length_um),])
Resp.Master_OM <- Resp.Master[!is.na(Resp.Master$Length_um),] %>% 
  dplyr::filter(!resp_blankStand < 0) %>% # ommit respiration values that are positive  
  dplyr::mutate(volume = 
                  
            case_when(
              
                      # F1 DATA HERE :::::::::::
              
                      filetype == "LoLigo_data" & Date %in% c('9/14/2021','9/30/2021') ~ 2.2,# fed F1 foodxOA
                      
                      filetype == "SDR_data" & Date %in% c('9/30/2021','10/26/2021')~ 1.7, # small unfed F1s foodxOA 
                      
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH1' ~ 23.1, # F1 data
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH2' ~ 23.05, 
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH4' ~ 22.55,
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH5' ~ 23.18,
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH6' ~ 23.24,
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH7' ~ 22.63, 
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH8' ~ 22.95,
                      # filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH3' ~ 23.31,
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH1' ~ 68.55323, # F1 data
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH2' ~ 68.85583, 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH4' ~ 68.95481,
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH5' ~ 68.57288,
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH6' ~ 68.01878,
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH7' ~ 68.54551, 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH8' ~ 68.53297,
                      filetype == "LoLigo_data" & Date %in% c('10/26/2021') & Channel == 'CH3' ~ 68.87473,

                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH1' ~ 68.55323, # F1 data
                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH2' ~ 68.85583, 
                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH4' ~ 68.95481,
                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH5' ~ 68.57288,
                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH6' ~ 68.01878,
                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH7' ~ 68.54551, 
                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH8' ~ 68.53297,
                      filetype == "LoLigo_data" & Date %in% c('2/2/2022','3/1/2022') & Channel == 'CH3' ~ 68.87473,
                      
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH1' ~ 196.6, # F1 data
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH2' ~ 200.6, 
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH3' ~ 201.4, 
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH4' ~ 200, 
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH5' ~ 199.2, 
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH6' ~ 200.4, 
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH7' ~ 201.3, 
                      filetype == "LoLigo_data" & Date %in% c('9/22/2022') & Channel == 'CH8' ~ 201.7, 
                      
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH1' ~ (236.70+18), # F1 data
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH2' ~ (239.88+18), 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH3' ~ (228.63+18), 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH4' ~ (234.35+18), 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH5' ~ (224.31+18), 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH6' ~ (229.07+18), 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH7' ~ (223.11+18), 
                      filetype == "LoLigo_data" & Date %in% c('10/26/2022') & Channel == 'CH8' ~ (225.59+18), 
                
                      # F2 DATA HERE :::::::::::
                      
                      filetype == "SDR_data" & Date %in% c('8/30/2022') ~ 0.08, # F2 data 
                      filetype == "SDR_data" & Date %in% c('9/22/2022') ~ 1.7,  # F2 data
                      
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH1' ~ 23.1, # F2 data
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH2' ~ 23.05,
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH3' ~ 23.31,
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH4' ~ 22.55,
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH5' ~ 23.18,
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH6' ~ 23.24,
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH7' ~ 22.63, 
                      filetype == "LoLigo_data" & Date %in% c('11/16/2022') & Channel == 'CH8' ~ 22.95, 
  
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH1' ~ 68.55323, # F1 data
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH2' ~ 68.85583, 
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH4' ~ 68.95481,
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH5' ~ 68.57288,
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH6' ~ 68.01878,
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH7' ~ 68.54551, 
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH8' ~ 68.53297,
                      filetype == "LoLigo_data" & Date %in% c('1/31/2023') & Channel == 'CH3' ~ 68.87473,                      
                      
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH1' ~ 198.2, # F2 data
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH2' ~ 212.5,
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH3' ~ 209.8,
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH4' ~ 211.8,
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH5' ~ 212.6,
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH6' ~ 212.8,
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH7' ~ 213.5, 
                      filetype == "LoLigo_data" & Date %in% c('2/23/2023','3/27/2023') & Channel == 'CH8' ~ 212, # F2 data
  
                      # F3 DATA HERE :::::::::::
                      
                      filetype == "SDR_data" & Date %in% c('4/7/2023','4/12/2023','4/18/2023','4/21/2023') ~ 0.08, # F3 data 
                      filetype == "SDR_data" & Date %in% c('5/18/2023') ~ 0.200)) %>%   # F2 data
  # BIOVOLUME 
  # note that biovolume was not measured for 9/14/2021, 9/30/2021, 10/26/21 (unfed only!), 9/22/22 (F2s only, SDR data)
 
   # (1) Vcap biovolume  - note we Aare NOT moving forward with this, however the regressions are great so I am keeping it for future reference (Sam)
  # Calculate biovolume using the volume of spherical cap and length measurements of scallops (leveraged data from Gurr et al. 2021 to test)
  dplyr::mutate(Length_mm = Length_um/1000) %>% 
  dplyr::mutate(Thickness_mm_estimate = Length_mm / 2.5) %>% # 2.5 ratio estimated in Biovolume_estimate.Rmd
  dplyr::mutate(h = as.numeric(Thickness_mm_estimate / 2)) %>% # divide by 2 fo the calculation of a single cap
  dplyr::mutate(a = as.numeric((Length_mm/0.97)/2)) %>% # 0.94 ratio estimated in Biovolume_estimate.Rmd
  dplyr::mutate(Cap_vol_L = ((1/6)*3.14*h)*(3*(a^2) + h^2)) %>% # Volume of a spherical cap (1/6)πh(3a2 + h2) == Vcap
  dplyr::mutate(Biovol_estimate_VCap = (Cap_vol_L*2)/1000)  %>% 

  # (2) Length^3
  # from length^3 to biovolume == (-0.00429)+(0.000198*x); x == length_mm^3 - this regression was run in biovolume testing script 
  dplyr::mutate(Biovol_length3 = (0.000198*(Length_mm^3)))  %>%  # calc biovolume based on length^3;  in Seember 2022 we decided to go with the length3 method for extrapolating biovolume for animals that do not have biovolume measurments 
  
  
  # CALCULATE THE ACTUAL VOLUME (accounting for measured and calculated biovolumes)
  
  # (1) 'calculated_volume' employing length^3 biovolume estimate to correct for volume displaces
  dplyr::mutate(calculated_volume = (volume - Biovol_length3)) %>%  # calculated biovolume based on length^3
  
  # (2) 'measured_volume' employing ONLY the measured values - resulting in many NAs for data where we did not measure it
  dplyr::mutate(measured_volume = (volume - Biovolume_g_in_sw)) %>%  # calculated biovolume based on length^3
  
  # NOTE: 'calcANDactual_volume' here is the continingency statement used to obtain a SINGLE resp value using (1) measured biovol when applicable (2) measured biovoume when measured is unavailable
  # as of 1/5/2023 - team decided they want TWO resp data files (1) only with measured biovolumes - including many NAs (2) only calculated - no NAs, used calculated value
  # dplyr::mutate(calcANDactual_volume = ifelse(is.na(Biovolume_g_in_sw), (volume - Biovol_length3), # NA, calculate actual volume using the calculated biovolume using the length^3 regression EQ
  #                                      #NOTE THE SMALL ANIMALS HAVE NEGATIVE BIOVOLUME USING TH ELENGTH 3 EQUATION, BUT POSITIVE USING VCAP
  #                               ifelse(Biovolume_g_in_sw > 0, (volume - Biovolume_g_in_sw), # if a value is present for biovolume, simply use it!
  #                                      NA))) %>%  # if the measured volume is below 0, poutput an NA, this should NEVER be the case (unless a typo!)
  
  
  
  # ESTIMATE MG HR RESP RATE in TWO ways

  # (1) using ONLY measured biovolume as 'Biovolume_g_in_sw' (resulting in many NAs!!!!)
  dplyr::mutate(resp_mg_hr   = ( (abs(resp_blankStand)) *  # currently as just mg O2 per minute - DOUBLE CHECK
                                      #(volume/1000) * # correct Liters - mg per L per min
                                      (measured_volume/1000) * # correct Liters - mg per L per min
                                       60) )  %>% # convert rate per minutes to rate per hour
  dplyr::mutate(resp_umol_hr = (resp_mg_hr*1000) / 32) %>% #  convert mg L per hr to umol L hr- first by mg to ug (mg*1000 = ug) and then ug to umol (1 umol = 32 ug -  ug O2 div 32 ug/umol)                                

  # (1) using ONLY calculated biovolumes to correct - should have no NAs
  dplyr::mutate(resp_mg_hr_biovolcalc   = ( (abs(resp_blankStand)) *  # currently as just mg O2 per minute - DOUBLE CHECK
                                      #(volume/1000) * # correct Liters - mg per L per min
                                      (calculated_volume/1000) * # correct Liters - mg per L per min
                                       60) )  %>% # convert rate per minutes to rate per hour
  dplyr::mutate(resp_umol_hr_biovolcalc = (resp_mg_hr_biovolcalc*1000) / 32) %>% #  convert mg L per hr to umol L hr- first by mg to ug (mg*1000 = ug) and then ug to umol (1 umol = 32 ug -  ug O2 div 32 ug/umol)                                

  # simplified start end rates used to compare O:N ratios 
  # dplyr::mutate(start.end_resp_mg_L_hr   = (start.end_resp_blankStand*(volume/1000)))  %>% # convert rate per minutes to rate per hour
  # dplyr::mutate(start.end_resp_umol_L_hr = (((start.end_resp_mg_L_hr) * (1000)) / 32) ) %>% #  convert mg L per hr to umol L hr- first by mg to ug (mg*1000 = ug) and then ug to umol (1 umol = 32 ug -  ug O2 div 32 ug/umol)                          
  
  
  dplyr::mutate(Age = # currently only set up for F1s
                  case_when(Date == '9/14/2021' ~ 50, 
                            Date == '9/30/2021' ~ 66, 
                            Date == '10/26/2021' ~ 92, 
                            Date == '2/2/2022' ~ 190, 
                            Date == '3/1/2022' ~ 217,
                            Date == '9/22/2022' & filetype == "LoLigo_data" ~ 423, # F2s also measured this day as SDR data 
                            Date == '10/26/2022' ~ 460)) %>% 
    
  dplyr::mutate(Fed_Unfed = 
                  case_when(Fed_Unfed == 'F' ~ "High food", 
                            is.na(Fed_Unfed) ~ "High food", 
                            Fed_Unfed == 'U' ~ "Low food")) %>% 
  dplyr::mutate(pCO2 = 
                  case_when(pH == 8.0 ~ "500 uatm", 
                            pH == 7.5 ~ "800 uatm",
                            pH == 7.0 ~ "1200 uatm"))

# diagnostics..
Resp.outliers <- Resp.Master %>% dplyr::filter(resp_blankStand < 0) # call negatives
# print(Resp.outliers) # 20 samples have negative values when correcting for the blank, meaning the blank rate was GREATER than the sample resp value
View(Resp.Master)

```

### Relationship between Whole dry weight  v. Shell length 

```{r DW v shell length plot,  echo=TRUE, message = FALSE, warning = FALSE}

Resp.Master_OM[!is.na(Resp.Master_OM$Dry_Tissue_weight),] %>% 
                                dplyr::mutate(Dry_Tissue_weight = as.numeric(Dry_Tissue_weight)) %>% 
                                ggplot(aes(x = Length_um, y = Dry_Tissue_weight)) +
                                geom_smooth(method = "loess") +
                                theme_classic() +
                                ylab("Scallop_TissueDW_mg") +
                                xlab("Length_um") +
                                geom_point() 


Resp.Master_OM[!is.na(Resp.Master_OM$Dry_Tissue_weight),] %>% 
                                dplyr::mutate(Dry_Tissue_weight = as.numeric(Dry_Tissue_weight)) %>% 
                                dplyr::mutate(whole_Dry_weight = as.numeric(whole_Dry_weight)) %>% 
                                ggplot(aes(x = whole_Dry_weight, y = Dry_Tissue_weight)) +
                                geom_smooth(method = "loess") +
                                theme_classic() +
                                ylab("Scallop_TissueDW_mg") +
                                xlab("whole_Dry_weight") +
                                geom_point() 

Resp.Master_OM[!is.na(Resp.Master_OM$Dry_Tissue_weight),] %>% 
                                dplyr::mutate(Dry_Tissue_weight = as.numeric(Dry_Tissue_weight)) %>% 
                                ggplot(aes(x = Dry_Tissue_weight, y = resp_umol_hr)) +
                                geom_smooth(method = "loess") +
                                theme_classic() +
                                ylab("resp_umol_L_hr") +
                                xlab("Dry_Tissue_weight") +
                                geom_point() 

Resp.Master_OM %>% ggplot(aes(x = Length_um, y = resp_umol_hr)) +
                                geom_smooth(method = "loess") +
                                theme_classic() +
                                ylab("resp_umol_L_hr") +
                                xlab("Length_um") +
                                geom_point() 
```

### Standardize rates as...

##### (1) shell length: umol L-1 O2 mm shell length hour-1
##### (2) whole dry weight: umol L-1 O2 g whole dry weight hour-1 

```{r Calculate Resp Rates & WRTIE CSV, echo=TRUE, message = FALSE, warning = FALSE}

#write.csv(Resp.Master_OM, "C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/Calculated_Resp_Master.csv")
write.csv(Resp.Master_OM, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/RR_calc_raw.csv")

Resp.Master_OM <- read.csv("Output/Respiration/RR_calc_raw.csv", head= T)

View(Resp.Master_OM)
```


# Metabolic scaling

* start the script from here if you already have the 'RR_calc_raw.csv' file above! 

* allometric scaling is a mandatory process to standardize rates to individual size, 
the gold standard being a dry weight based on whole body tisssue or even respiratory organ-specific tissue

* below we run metabolic scaling for tissue dry weight and shell length of our bay scallops, our team decided 
that, though tissue dry weights are the gold standard, shell length was measured throughout our experiment for all 
size classes, thus a more holistic (experimentally) metric for scaling - also represents a versatile tool that does
not require destructive sampling! 

* we have three generations of respiration rate data - below we separate into datasets for uniqe columnds and merge
back together. May also be interesting to explore metabolic scaling across generations

### load data and create master dataset for scaling 

* we have separate files for each generation as 'RR_master_F1', 'RR_master_F2', etc. 

* includes a new 'Age' and 'Gen' column

  - merged into one master file, we can isolate generation data using the new column!

```{r, load data}
# F1s ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
RR_master_F1 <- read.csv(file="Output/Respiration/RR_calc_raw.csv", header=T) %>% 
              filter(!Food %in% 'unfed') %>% # omit low food trial data
              # filter out the F2 measurements
              filter(!Date %in% c('8/30/2022', '11/16/2022','8/30/2022', 
                                  '11/16/2022', '1/31/2023', '2/23/2023', 
                                  '3/27/2023',  '5/18/2023')) %>% # an F2 measurement
              filter(!(Date == '9/22/2022' & filetype =='SDR_data')) %>%  # F2s were also measured on 9/22 but with the SDR system (F1s with the LoLigo)
              dplyr::mutate(Age = case_when(Date == '9/14/2021'  ~ 50,
                                            Date == '9/30/2021'  ~ 66,
                                            Date == '10/26/2021'  ~ 92, 
                                            Date == '2/2/2022' ~ 191,
                                            Date == '3/1/2022'  ~ 218,
                                            Date == '9/22/2022'  ~ 423,
                                            Date == '10/26/2022' ~ 457)) %>% 
              dplyr::mutate(Gen = 'F1') %>% 
              dplyr::mutate(Age = as.factor(Age)) %>% 
              dplyr::arrange(Age)
unique(RR_master_F1$Date)
 # "9/14/2021"  "9/30/2021"  "10/26/2021" "2/2/2022"   "3/1/2022"   "9/22/2022"  "10/26/2022"

# F2s ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
RR_master_F2 <- read.csv(file="Output/Respiration/RR_calc_raw.csv", header=T) %>% 
              filter(!Food %in% 'unfed') %>% # omit low food trial data
              # filter out the F2 measurements
              filter(Date %in% c('8/30/2022', '9/22/2022', '11/16/2022', 
                                 '1/31/2023', '2/23/2023', '3/27/2023')) %>% # an F2 measurement
              filter(!(Date == '9/22/2022' & filetype =='LoLigo_data')) %>% # F1s were also measured on 9/22 but with the LoLigo system (F2s with the SDR)
  # unique(RR_master$Date) # "10/26/2021" "2/2/2022"   "3/1/2022"   "8/30/2022"  "9/14/2021"  "9/22/2022"  "9/30/2021"
              dplyr::mutate(Age = case_when(Date == '8/30/2022'   ~ 13,
                                            Date == '9/22/2022'   ~ 36,
                                            Date == '11/16/2022'  ~ 91, 
                                            Date == '1/31/2023'   ~ 167,
                                            Date == '2/23/2023'   ~ 190,
                                            Date == '3/27/2023'   ~ 222)) %>% 
              dplyr::mutate(Gen = 'F2') %>% 
              dplyr::mutate(Age = as.factor(Age)) %>% 
              dplyr::arrange(Age)
unique(RR_master_F2$Date)
# "8/30/2022"  "9/22/2022"  "11/16/2022" "1/31/2023"  "2/23/2023"  "3/27/2023"
# View(RR_master)


# F3s ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
RR_master_F3 <- read.csv(file="Output/Respiration/RR_calc_raw.csv", header=T) %>% 
              # filter out targets
              filter(Date %in% c('5/18/2023')) %>% # an signle F3 grow out measurment (so far!!!) 
              dplyr::mutate(Age = case_when(Date == '5/18/2023'   ~ 100)) %>% 
              dplyr::mutate(Gen = 'F3') %>% 
              dplyr::mutate(Age = as.factor(Age)) %>% 
              dplyr::arrange(Age)
unique(RR_master_F3$Date)
# "5/18/2023"

RR_master <- rbind(RR_master_F1, RR_master_F2, RR_master_F3)
# View(RR_master)

```

### F1 Summary tables

```{r shell lengths at each timepoint, echo = FALSE}

SumTable <- RR_master_F1[!is.na(RR_master_F1$Length_um),] %>%  
            mutate(Length_mm = Length_um/1000) %>% 
            summarySE(measurevar="Length_mm", groupvars=c("Date", "Age")) %>% 
            dplyr::arrange(Age)
SumTable

SumTable_treatment <- RR_master_F1[!is.na(RR_master_F1$Length_um),] %>%  
            mutate(Length_mm = Length_um/1000) %>% 
            summarySE(measurevar="Length_mm", groupvars=c("Date", "Age", "pCO2")) %>% 
            dplyr::arrange(Age)
SumTable_treatment
```

### F2 Summary tables

```{r shell lengths at each timepoint, echo = FALSE}

SumTable <- RR_master_F2[!is.na(RR_master_F2$Length_um),] %>%  
            mutate(Length_mm = Length_um/1000) %>% 
            summarySE(measurevar="Length_mm", groupvars=c("Date", "Age")) %>% 
            dplyr::arrange(Age)
SumTable

SumTable_treatment <- RR_master_F2[!is.na(RR_master_F2$Length_um),] %>%  
            mutate(Length_mm = Length_um/1000) %>% 
            summarySE(measurevar="Length_mm", groupvars=c("Date", "Age", "pCO2")) %>% 
            dplyr::arrange(Age)
SumTable_treatment
```

```{r}

# make pCO2 a factor and adjust levels for plotting
RR_master$pCO2 <- factor(RR_master$pCO2, levels = c("500 uatm", "800 uatm", "1200 uatm"))
# adjust the master sheet and omit NAs
# adjustment below calls a single 'resp_umol_hr' to include all values 
# those with measured volume-adjusted and those with calculated volume adjusted
# What does this mean? We were unable to measure biovolume for all RR measurements, but 
# we ran correlations bwtween biovolume and shell volume based on cubed shell length, this provides 
# us with an estimation of volume to adjust RR rates in the RR_calc_master (earlier in this markdown!)
RR_master_OM            <- RR_master %>% 
                            mutate(resp_umol_hr = 
                                    # print the calculate volume adjusted RR when measrued ovl was not avail
                                     case_when(measured_volume %in% NA ~ resp_umol_hr_biovolcalc,
                                    # when measured vol was availabel, simply print the rate present
                                               TRUE ~ resp_umol_hr)) %>% 
                            filter(!is.na(resp_umol_hr)) # ommit cases when respiration is NA 

nrow(RR_master_OM) # 317

```

# ALOMETRIC COEFFICIENT (b factor)

## by TISSUE DRY WEIGHT ::::::::::

```{r b factor TISSUE DRY WEIGHT, echo = FALSE, message = FALSE, warning = FALSE, results='hide'}


nrow(RR_master_OM %>% dplyr::filter(Dry_Tissue_weight >0)) # 161
nrow(RR_master_OM %>% dplyr::filter(Length_um >0)) # 317
nrow(RR_master_OM %>% dplyr::filter(resp_umol_hr_biovolcalc >0)) # 317
# ABOUT: 

# from Bayne text (page 360)

# b is the scaling exponent, 
# log10_M_O2 = log10_a + (b.factor * log10_Mass) 
# M_O2 ∝ a*Mass^(b.factor),
# y   =  m(x)^b.factor

# b = the coefficient estimated empirically by fitting the allometric equation below
# [ln(VO2])] = ln(a) + b*(ln(TDW))


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR FOR ALL AVAILABLE INDIVIDUALS WITH TDW AND MO2 ::::::::::::::::::::::::::::::
RR_master_OM$log10_VO2  <- log10(as.numeric(RR_master_OM$resp_umol_hr)) # assign resp value
RR_master_OM$log10_TDW  <- log10(as.numeric(RR_master_OM$Dry_Tissue_weight)) # assign length value 
#summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_TDW)) # 0.79749 == b factor




MO2_b.factor_PLOT <- RR_master_OM %>% 
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                          geom_point() +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, 
                                                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                                                label.x.npc = "left")
# MO2_b.factor_PLOT



MO2_b.factor_PLOT_facetted <- RR_master_OM %>% 
                       ggplot(aes(x=log10_TDW, y=log10_VO2, color = pCO2)) +
                          geom_point() +
                          scale_color_manual(values=c("blue","orange", "purple")) +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, 
                                                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                                                label.x.npc = "left") +
                          facet_wrap(~pCO2)
# MO2_b.factor_PLOT_facetted

# two outliers to remove and rerun below
print(ggarrange(MO2_b.factor_PLOT, MO2_b.factor_PLOT_facetted, nrow = 2, ncol = 1)) # print the model diagnostics
RR_master_OM %>% dplyr::filter((log10_TDW > -0.5 & log10_VO2 < -0.2)) # call these two outliers


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR TWO OUTLIERS OMITTED (VIEW THE PREVIOUS) ::::::::::::::::::::::::::::::
RR_master_OM$log10_VO2  <- log10(as.numeric(RR_master_OM$resp_umol_hr)) # assign resp value
RR_master_OM$log10_TDW  <- log10(as.numeric(RR_master_OM$Dry_Tissue_weight)) # assign length value 
# summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_TDW)) # 0.79749 == b factor


MO2_b.factor_PLOT_OM <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") #+
                          # geom_smooth(method = lm, color = 'red') +
                          # ggpmisc::stat_poly_eq(parse=T, 
                          #                       aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                          #                       label.x.npc = "left")

# by generation
MO2_b.factorTDW_PLOT_Gen <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                                      geom_point() +
                                      ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                                      ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                                      theme(panel.grid.major = element_blank(), 
                                            panel.grid.minor = element_blank())+ 
                                      scale_x_continuous(name ="log10_Length; in mm") +
                                      scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                      theme_classic() +
                                      theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                      ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                              (b.factor * log10_Length)") +
                                      # geom_smooth(method = lm, color = 'red') +
                                      # ggpmisc::stat_poly_eq(parse=T, 
                                      #                       aes(label = paste(..eq.label.., ..rr.label.., 
                                      #                                         sep = "~~~")),
                                      #                       label.x.npc = "left") +
                                      facet_wrap(~Gen)
# by treatment
MO2_b.factorTDW_PLOT_pCO2 <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                                      geom_point() +
                                      ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                                      ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                                      theme(panel.grid.major = element_blank(), 
                                            panel.grid.minor = element_blank())+ 
                                      scale_x_continuous(name ="log10_Length; in mm") +
                                      scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                      theme_classic() +
                                      theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                      ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                              (b.factor * log10_Length)") +
                                      # geom_smooth(method = lm, color = 'red') +
                                      # ggpmisc::stat_poly_eq(parse=T, 
                                      #                       aes(label = paste(..eq.label.., ..rr.label.., 
                                      #                                         sep = "~~~")),
                                      #                       label.x.npc = "left") +
                                      facet_wrap(~pCO2)


MO2_b.factorTDW_PLOT_pCO2_Gen <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2, color = pCO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                          scale_color_manual(values=c("forestgreen","darkorange", "purple")) +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          # geom_smooth(method = lm, color = 'red') +
                          # ggpmisc::stat_poly_eq(parse=T, 
                          #                       aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                          #                       label.x.npc = "left") +
                          facet_wrap(~pCO2*Gen)

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_TDW_OM.pdf"), width = 8, height = 16)
print(ggarrange(MO2_b.factor_PLOT_OM, 
                MO2_b.factorTDW_PLOT_Gen,
                MO2_b.factorTDW_PLOT_pCO2,
                MO2_b.factorTDW_PLOT_pCO2_Gen, 
                nrow = 4, ncol = 1)) # print the model diagnostics 
dev.off()
print(ggarrange(MO2_b.factor_PLOT_OM, 
                MO2_b.factorTDW_PLOT_Gen,
                MO2_b.factorTDW_PLOT_pCO2,
                MO2_b.factorTDW_PLOT_pCO2_Gen, 
                nrow = 4, ncol = 1)) # print the model diagnostics 




# F1 and F2 TDW bfactor, LOW and MODERATE pCO2
TDW_RR_b.factor_LowVMod <- RR_master_OM %>% 
                              dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                              dplyr::filter(!pCO2 %in% '1200 uatm') %>% # omit high pCO2 from F2 samples
                              dplyr::filter(!Gen %in% 'F3') %>% 
                              dplyr::mutate(Gen_pCO2 = paste0(Gen,'_',pCO2)) %>% 
                              ggplot(aes(x=log10_TDW, 
                                         y=log10_VO2, 
                                         color = Gen_pCO2,
                                         shape = Gen_pCO2)) +
                              geom_point(size = 2) +
                              ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                              ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                              scale_color_manual(values=c("forestgreen","darkorange","forestgreen","darkorange")) +
                              scale_shape_manual(values=c(19, 19, 1,1)) +
                              theme(panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank())+ 
                              scale_x_continuous(name ="log10_TDW; in mm") +
                              scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                              ylim(-1.5,2) +
                              theme_classic() +
                              theme(legend.position="none",
                                    element_line(linewidth = 0.5, color = 'black'),
                                    axis.title.y=element_text(size=12),
                                    axis.text.x=element_text(size=(12)),
                                    axis.text.y=element_text(size=(12))) + # legend.position="none",
                              ggtitle("Allometric scaling: log10_VO2 = log10_a + (b.factor * log10_TDW)") +
                              scale_linetype_discrete(name="Gen x pCO2", 
                                                      breaks=c("F1_500 uatm", 
                                                               "F1_800 uatm", 
                                                               "F2_500 uatm", 
                                                               "F2_800 uatm"), 
                                                      labels = c("F1 x low pCO2", 
                                                                 "F1 x moderate pCO2", 
                                                                 "F2 x low pCO2",
                                                                 "F2 x moderate pCO2"))
TDW_RR_b.factor_LowVMod_facetted  <- TDW_RR_b.factor_LowVMod + facet_wrap(~Gen)

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/F1_F2_RR_bFactor_TDW_LowvMod.pdf"), 
    width = 5, height = 10)
print(ggpubr::ggarrange(TDW_RR_b.factor_LowVMod,
                        TDW_RR_b.factor_LowVMod_facetted, nrow = 2, ncol = 1)) # print the model diagnostics
dev.off() 


# F2 TDW bfactor, LOW and High pCO2
levels(RR_master_OM$pCO2)
F2_TDW_RR_b.factor_LowVHigh <- RR_master_OM %>% 
                              dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                              dplyr::filter(!pCO2 %in% '800 uatm') %>% # omit high pCO2 from F2 samples
                              dplyr::filter(!Gen %in% c('F1','F3')) %>% 
                              dplyr::mutate(Gen_pCO2 = paste0(Gen,'_',pCO2)) %>% 
                              ggplot(aes(x=log10_TDW, 
                                         y=log10_VO2, 
                                         color = Gen_pCO2,
                                         shape = Gen_pCO2)) +
                              geom_point(size = 2) +
                              ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                              ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                              scale_color_manual(values=c("purple","forestgreen")) +
                              scale_shape_manual(values=c(19, 19)) +
                              theme(panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank())+ 
                              scale_x_continuous(name ="log10_TDW; in mm") +
                              scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                              ylim(-1,2) +
                              theme_classic() +
                              theme(legend.position="none",
                                    element_line(linewidth = 0.5, color = 'black'),
                                    axis.title.y=element_text(size=12),
                                    axis.text.x=element_text(size=(12)),
                                    axis.text.y=element_text(size=(12))) + # legend.position="none",
                              ggtitle("Allometric scaling: log10_VO2 = log10_a + (b.factor * log10_TDW)") 


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/F2_RR_bFactor_TDW_LowvHigh.pdf"), 
    width = 5, height = 5)
print(F2_TDW_RR_b.factor_LowVHigh) # print the model diagnostics
dev.off() 


```

### summary:
* all
-   TDW b factor total = 0.801
* Generation
-  F1 TDW b factor  = 0.724
-  F2 TDW b factor  = 0.955
* treamtent
-   Low pCO2 TDW b factor  = 0.758
-   Moderate pCO2 TDW b factor  = 0.775
-   High pCO2 TDW b factor  = 1.05
*  treamtent x Generation
F1
-   Low pCO2 F1 TDW b factor  = 0.732
-   Moderate pCO2 F1 TDW b factor  = 0.710
F2
-   Low pCO2 F2 TDW b factor  = 0.826
-   Moderate pCO2 F2 TDW b factor  = 0.986
-   High pCO2 F2 TDW b factor  = 1.05

## by TISSUE DRY WEIGHT (biovol calculated) ::::::::::

```{r b factor TISSUE DRY WEIGHT, echo = FALSE, message = FALSE, warning = FALSE, results='hide'}


# ABOUT: 

# from Bayne text (page 360)

# b is the scaling exponent, 
# log10_M_O2 = log10_a + (b.factor * log10_Mass) 
# M_O2 ∝ a*Mass^(b.factor),
# y   =  m(x)^b.factor

# b = the coefficient estimated empirically by fitting the allometric equation below
# [ln(VO2])] = ln(a) + b*(ln(TDW))


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR FOR ALL AVAILABLE INDIVIDUALS WITH TDW AND MO2 ::::::::::::::::::::::::::::::
RR_master_OM$log10_VO2  <- log10(as.numeric(RR_master_OM$resp_umol_hr_biovolcalc)) # assign resp value
RR_master_OM$log10_TDW  <- log10(as.numeric(RR_master_OM$Dry_Tissue_weight)) # assign length value 
#summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_TDW)) # 0.79749 == b factor

MO2_b.factor_PLOT <- RR_master_OM %>% 
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                          geom_point() +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left")
# MO2_b.factor_PLOT



MO2_b.factor_PLOT_facetted <- RR_master_OM %>% 
                       ggplot(aes(x=log10_TDW, y=log10_VO2, color = pCO2)) +
                          geom_point() +
                          scale_color_manual(values=c("blue","orange", "purple")) +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left") +
                          facet_wrap(~pCO2)
# MO2_b.factor_PLOT_facetted


# OUTPUT PLOTS 
# same as before
print(ggarrange(MO2_b.factor_PLOT, MO2_b.factor_PLOT_facetted, nrow = 2, ncol = 1)) # print the model diagnostics
 



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR TWO OUTLIERS OMITTED (VIEW THE PREVIOUS) ::::::::::::::::::::::::::::::
RR_master_OM$log10_VO2  <- log10(as.numeric(RR_master_OM$resp_umol_hr_biovolcalc)) # assign resp value
RR_master_OM$log10_TDW  <- log10(as.numeric(RR_master_OM$Dry_Tissue_weight)) # assign length value 
# summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_TDW)) # 0.79749 == b factor


MO2_b.factor_PLOT_OM <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                          geom_point() +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, 
                                                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                                                label.x.npc = "left")

MO2_b.factor_PLOT_facetted_OM <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -0.5 & 
                                         log10_VO2 < -0.2)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2, color = pCO2)) +
                          geom_point() +
                          scale_color_manual(values=c("blue","orange", "purple")) +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, 
                                                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                                                label.x.npc = "left") +
                          facet_wrap(~pCO2)

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_TDW_OM_biovolcalc.pdf"), width = 8, height = 8)
print(ggarrange(MO2_b.factor_PLOT_OM, MO2_b.factor_PLOT_facetted_OM, nrow = 2, ncol = 1)) # print the model diagnostics 
dev.off()
print(ggarrange(MO2_b.factor_PLOT_OM, MO2_b.factor_PLOT_facetted_OM, nrow = 2, ncol = 1)) # print the model diagnostics 

```

### summary: same as the biovolume measured!

## by SHELL AND INDIVIDUAL LENGTH (only for biovolume calculated using length\^3)

-   why? - we want to compare resp data across time however we did not measure dry tissue nor biovolume in small animals, thus to calculate resp using the sample methods across time, we used length\^3 correction for biovolume and will further use a bfactor for shell length in these data

-   note: this is in contrast to resp values used for SFG, O:N, and any overlaid phys with ecretion and biodeposition becasue animals were large enough to have tissue dry weights and biovolumes

```{r b factor SHELL AND INDIVIDUAL LENGTH, echo=TRUE, echo = FALSE,message = FALSE, warning = FALSE, results='hide'}

# FOR SHELL ENGTH WE WILL USE THE 'resp_umol_hr_biovolcalc' data to employ all resp data files across time! 
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR FOR ALL AVAILABLE INDIVIDUALS WITH LENGTH AND MO2 ::::::::::::::::::::::::::::::
nrow(RR_master_OM) # 317
RR_master_OM$log10_VO2     <- log10(as.numeric(RR_master_OM$resp_umol_hr_biovolcalc)) # assign resp value
RR_master_OM$log10_Length  <- log10(as.numeric(RR_master_OM$Length_um)) # assign length value 
#summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_Length)) # 1.8502 == b factor

# all
MO2_b.factorLENGTH_PLOT <- RR_master_OM %>% 
                            ggplot(aes(x=log10_Length, y=log10_VO2)) +
                            geom_point() +
                            ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                            ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank())+ 
                            scale_x_continuous(name ="log10_Length; in mm") +
                            scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                            theme_classic() +
                            theme(legend.position="none",axis.title.y=element_text(size=7)) +
                            ggtitle("RR Length scaling: log10_VO2 = log10_a + (b.factor * log10_Length)")
                            
                            
                            
MO2_b.factorLENGTH_PLOT_Gen <- RR_master_OM %>% 
                            ggplot(aes(x=log10_Length, y=log10_VO2)) +
                            geom_point() +
                            ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                            ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank())+ 
                            scale_x_continuous(name ="log10_Length; in mm") +
                            scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                            theme_classic() +
                            theme(legend.position="none",axis.title.y=element_text(size=7)) +
                            ggtitle("RR Length scaling: log10_VO2 = log10_a + (b.factor * log10_Length)") +
                            facet_wrap(~Gen)
# by treatment
MO2_b.factorLENGTH_PLOT_pCO2 <- RR_master_OM %>% 
                            ggplot(aes(x=log10_Length, y=log10_VO2)) +
                            geom_point() +
                            ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                            ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank())+ 
                            scale_x_continuous(name ="log10_Length; in mm") +
                            scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                            theme_classic() +
                            theme(legend.position="none",axis.title.y=element_text(size=7)) +
                            ggtitle("RR Length scaling: log10_VO2 = log10_a + (b.factor * log10_Length)") +
                            facet_wrap(~pCO2)


# by generation * treatment
MO2_b.factorLENGTH_PLOT_pCO2_Gen <- RR_master_OM %>% 
                                    ggplot(aes(x=log10_Length, y=log10_VO2)) +
                                    geom_point() +
                                    scale_color_manual(values=c("forestgreen","darkorange","purple")) +
                                    ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                                    ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +
                                    theme(panel.grid.major = element_blank(), 
                                          panel.grid.minor = element_blank())+ 
                                    scale_x_continuous(name ="log10_Length; in mm") +
                                    scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                                    theme_classic() +
                                    theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                    ggtitle("RR Length scaling: log10_VO2 = log10_a + (b.factor * log10_Length)") +
                                    facet_wrap(~pCO2*Gen)



# OUTPUT PLOTS 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_LENGTH.pdf"), width = 8, height = 16)
print(ggarrange(MO2_b.factorLENGTH_PLOT,
                MO2_b.factorLENGTH_PLOT_Gen,
                MO2_b.factorLENGTH_PLOT_pCO2,
                MO2_b.factorLENGTH_PLOT_pCO2_Gen, nrow = 4, ncol = 1)) # print the model diagnostics
dev.off() 


# F1 and F2 TDW bfactor, LOW and MODERATE pCO2
Length_RR_b.factor_LowVMod <- RR_master_OM %>% 
                              dplyr::filter(!pCO2 %in% '1200 uatm') %>% # omit high pCO2 from F2 samples
                              dplyr::filter(!Gen %in% 'F3') %>% 
                              dplyr::mutate(Gen_pCO2 = paste0(Gen,'_',pCO2)) %>% 
                              ggplot(aes(x=log10_Length, 
                                         y=log10_VO2, 
                                         color = Gen_pCO2,
                                         shape = Gen_pCO2)) +
                              geom_point(size = 2) +
                              ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                              ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                              scale_color_manual(values=c("forestgreen","darkorange","forestgreen","darkorange")) +
                              scale_shape_manual(values=c(19, 19, 1,1)) +
                              theme(panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank())+ 
                              scale_x_continuous(name ="log10_Length; in mm") +
                              scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                              # ylim(-2,2) +
                              theme_classic() +
                              theme(legend.position="none",
                                    element_line(linewidth = 0.5, color = 'black'),
                                    axis.title.y=element_text(size=12),
                                    axis.text.x=element_text(size=(12)),
                                    axis.text.y=element_text(size=(12))) + # legend.position="none",
                              ggtitle("Allometric scaling: log10_VO2 = log10_a + (b.factor * log10_Length)") +
                              scale_linetype_discrete(name="Gen x pCO2", 
                                                      breaks=c("F1_500 uatm", 
                                                               "F1_800 uatm", 
                                                               "F2_500 uatm", 
                                                               "F2_800 uatm"), 
                                                      labels = c("F1 x low pCO2", 
                                                                 "F1 x moderate pCO2", 
                                                                 "F2 x low pCO2",
                                                                 "F2 x moderate pCO2"))
Length_RR_b.factor_LowVMod_facetted  <- Length_RR_b.factor_LowVMod + facet_wrap(~Gen)

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/F1_F2_RR_bFactor_Length_LowvMod.pdf"), 
    width = 5, height = 10)
print(ggpubr::ggarrange(Length_RR_b.factor_LowVMod,
                        Length_RR_b.factor_LowVMod_facetted, nrow = 2, ncol = 1)) # print the model diagnostics
dev.off() 


# F2 TDW bfactor, LOW and High pCO2 - just the time points of F2 that have hihgh OA and low OA data
levels(RR_master_OM$pCO2)
F2_Length_RR_b.factor_LowVHigh <- RR_master_OM %>% 
                              dplyr::filter(!pCO2 %in% '800 uatm') %>% # omit high pCO2 from F2 samples
                              dplyr::filter(!Gen %in% c('F1','F3')) %>% 
                              dplyr::mutate(Gen_pCO2 = paste0(Gen,'_',pCO2)) %>% 
                              ggplot(aes(x=log10_Length, 
                                         y=log10_VO2, 
                                         color = Gen_pCO2,
                                         shape = Gen_pCO2)) +
                              geom_point(size = 2) +
                              ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                              ggpmisc::stat_ma_eq(ggpmisc::use_label(c("eq", "n", "R2"))) +  
                              scale_color_manual(values=c("purple","forestgreen")) +
                              scale_shape_manual(values=c(19, 19)) +
                              theme(panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank())+ 
                              scale_x_continuous(name ="log10_Length; in mm") +
                              scale_y_continuous(name ="log10_VO2; RR in umol L-1 hr-1)") +
                              xlim(4,4.8) + # if you comment our these you can see there much more ealier data for low OA than high OA
                              ylim(-2,2) + # if you comment our these you can see there much more ealier data for low OA than high OA
                              theme_classic() +
                              theme(legend.position="none",
                                    element_line(linewidth = 0.5, color = 'black'),
                                    axis.title.y=element_text(size=12),
                                    axis.text.x=element_text(size=(12)),
                                    axis.text.y=element_text(size=(12))) + # legend.position="none",
                              ggtitle("Allometric scaling: log10_VO2 = log10_a + (b.factor * log10_Length)") 


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/F2_RR_bFactor_Length_LowvHigh.pdf"), 
    width = 5, height = 5)
print(F2_Length_RR_b.factor_LowVHigh) # print the model diagnostics
dev.off() 



```

### summary:

-   Length b factor total = 2.16 
Generation
-   Length b factor pCO2 F1 = 2.3
-   Length b factor pCO2 F2 = 1.74 
-   Length b factor pCO2 F3 = 8.38
Treatment
-   Length b factor pCO2 low = 2.21
-   Length b factor pCO2 moderate = 2.05
-   Length b factor pCO2 high = 2.5
Generation * Treatment
F1
-   Length b factor pCO2 low = 2.34
-   Length b factor pCO2 moderate = 2.25
F2
-   Length b factor pCO2 low = 1.8 (Note we have 3.4 when truncating to data to compare to high OA OTHER PAPER LOOKING AT LOW V HIGH F2)
-   Length b factor pCO2 moderate = 1.71 
-   Length b factor pCO2 high = 7.27 
F3
-   Length b factor pCO2 low = 14.3 
-   Length b factor pCO2 moderate = 10.4 
-   Length b factor pCO2 high = 6.01 

# F1s master file

-   calculate RR rates with b factor and my mean tissue and mean shell length

```{r, RR_formatted_F1smaster}

# call all bfactors (calc above!) - these are using all data
bTDW = 0.724 # review the outlier-omitted b factor plot in previous chunk
bLength.all = 2.3 # review the outlier-omitted b factor plot in previous chunk

# assign bfactors by treatment
bTDW.low <-  0.732 #mean data by rep tank # 6.99 - with all data
bTDW.mod <-  0.710 #mean data by rep tank # 6.57 - with all data

bLength.low <-  2.34 #mean data by rep tank # 6.99 - with all data
bLength.mod <-  2.25 #mean data by rep tank # 6.57 - with all data

# call the mean lengths of animals measured
RR_master_F1$Dry_Tissue_weight <- as.numeric(RR_master_F1$Dry_Tissue_weight)

meanTDW      <- mean((RR_master_F1 %>% 
                        dplyr::filter(!pH %in% 7) %>% # only looking at 8 and 7.5 NOT 7 here 
                        dplyr::filter(!Dry_Tissue_weight %in% NA))$Dry_Tissue_weight) # 0.4750597 g

meanLength   <- mean((RR_master_F1 %>% 
                        dplyr::filter(!pH %in% 7) %>% # only looking at 8 and 7.5 NOT 7 here 
                        dplyr::filter(!Length_um %in% NA))$Length_um) /1000 # 16.57877 mm


#View(RR_formatted_F1s$TDW_um)
# SMRnorm = VO2 × (TDWmean / TDWindiv)b = µmol L-1 O2 g-1 hr-1
# SMRnorm = VO2 × (SHmean / SHindiv)b = µmol L-1 O2 mm-1 hr-1

RR_formatted_F1smaster <- RR_master_F1 %>% 
  
                              mutate(resp_umol_hr = 
                                    # print the calculate volume adjusted RR when measrued ovl was not avail
                                     case_when(measured_volume %in% NA ~ resp_umol_hr_biovolcalc,
                                    # when measured vol was availabel, simply print the rate present
                                               TRUE ~ resp_umol_hr)) %>% 
  

                              mutate(resp_mg_hr = 
                                    # print the calculate volume adjusted RR when measrued ovl was not avail
                                     case_when(measured_volume %in% NA ~ resp_mg_hr_biovolcalc,
                                    # when measured vol was availabel, simply print the rate present
                                               TRUE ~ resp_mg_hr)) %>% 
  
  
                              dplyr::mutate(
                                            
                                            resp_umol_hr_bFactorNormTDW.MEAN = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((meanTDW/Dry_Tissue_weight)^bTDW.low),
                                                pH  == 7.5 ~ (resp_umol_hr)*((meanTDW/Dry_Tissue_weight)^bTDW.mod)
                                              ),
                                            
                                            resp_umol_hr_bFactorNormTDW.1g = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((1/Dry_Tissue_weight)^bTDW.low),
                                                pH  == 7.5 ~ (resp_umol_hr)*((1/Dry_Tissue_weight)^bTDW.mod)
                                              ), 
                                            
                                            resp_umol_hr_bFactorNormLength.MEAN = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((meanLength/Length_mm)^bLength.low),
                                                pH  == 7.5 ~ (resp_umol_hr)*((meanLength/Length_mm)^bLength.mod)
                                              ) 
                                            ) %>% 
                              
                              dplyr::select(c(Gen,
                                              Age,
                                              Date,
                                              pH,
                                              pCO2,
                                              Replicate,
                                              Chamber_tank,
                                              Number,
                                              Run,
                                              Channel,
                                              filetype,
                                              Filename,
                                              Food,
                                              Length_um,
                                              Length_mm,
                                              Dry_Shell_weight,
                                              Dry_Tissue_weight,
                                              whole_Dry_weight,
                                              volume,
                                              Biovolume_g_in_sw,
                                              measured_volume, # as vessel volume - meausred biovolume (NAs where note measured)
                                              Biovol_length3,
                                              calculated_volume, # as vessel volume - (biovol calc from length^3)
                                              Lpc,
                                              BLANK.mean_Lpc,
                                              resp_blankStand,
                                              resp_mg_hr, 
                                              resp_umol_hr,
                                              resp_mg_hr_biovolcalc,
                                              resp_umol_hr_biovolcalc,  
                                              
                                              resp_umol_hr_bFactorNormTDW.1g, 
                                              resp_umol_hr_bFactorNormTDW.MEAN,

                                              resp_umol_hr_bFactorNormLength.MEAN))
#View(RR_formatted_F1smaster)
write.csv(RR_formatted_F1smaster, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/F1/F1_RR_calc_master.csv")
write.csv(RR_formatted_F1smaster, "C:/Users/samuel.gurr/Documents/Github_repositories/EAD-ASEB-Airradians_multigen_OA/RAnalysis/Output/Respiration/F1/F1_RR_calc_master.csv")

```

# F2s master file

-   calculate RR rates with b factor and my mean tissue and mean shell length

```{r, RR_formatted_F2smaster}

# call all bfactors (calc above!) - these are using all data
bTDW        = 0.955 # review the outlier-omitted b factor plot in previous chunk
bLength.all = 1.74 # review the outlier-omitted b factor plot in previous chunk

# assign bfactors by treatment
bTDW.low <-  0.826 #mean data by rep tank # 6.99 - with all data, WE DO NOT NEED SPECIAL CASE TO COMPARE TO HIGH BECAUSE THIS IS TDW, recorded as same timepoints as high OA
bTDW.mod <-  0.986 #mean data by rep tank # 6.57 - with all data
bTDW.high <-  1.05 #mean data by rep tank # 6.57 - with all data

# note that high values for length b factor - LvH uses a different low b factor to compare these!
bLength.low.LvH <- 3.4 # USE THIS FOR LOW V HIGH, omits earlier values for low when high was not present or measured
bLength.low  <-  1.8 #mean data by rep tank USE THIS FOR LOW V MODERATE # 6.99 - with all data
bLength.mod  <-  1.71 #mean data by rep tank # 6.57 - with all data
bLength.high <-  7.27 #mean data by rep tank # 6.57 - with all data

# calc the mean for TDw and length
RR_master_F2$Dry_Tissue_weight <- as.numeric(RR_master_F2$Dry_Tissue_weight)

F2_meanLength_all  <- mean(RR_master_F2$Length_um/1000) # 18.34275 mm

F2_meanLength_LvM   <- mean(
                            (RR_master_F2 %>% filter(!pCO2 %in% '1200 uatm'))$Length_um / 1000
                            )# 15.4249 mm

F2_meanLength_LvH   <-  mean(
                            (RR_master_F2 %>% 
                               dplyr::filter(!Dry_Tissue_weight %in% NA) %>% # later life stages only when high and low OA were present 
                               # this truncates out the small size data that we have for F2 under low without high, 
                               # all high measurements also had dry tissue (later life stages)
                               filter(!pCO2 %in% '800 uatm'))$Length_um / 1000
                            )# 30.45804 mm



F2_meanTDW_all     <- mean((RR_master_F2 %>% 
                     dplyr::filter(!Dry_Tissue_weight %in% NA))$Dry_Tissue_weight) # 0.3692024 g

F2_meanTDW_LvM     <- mean(
                           (RR_master_F2 %>% 
                              dplyr::filter(!Dry_Tissue_weight %in% NA) %>% 
                              dplyr::filter(!pCO2 %in% '1200 uatm'))$Dry_Tissue_weight
                           )# 0.3579696 g

F2_meanTDW_LvH   <-  mean(
                           (RR_master_F2 %>% 
                              dplyr::filter(!Dry_Tissue_weight %in% NA) %>% 
                              dplyr::filter(!pCO2 %in% '800 uatm'))$Dry_Tissue_weight
                           )# 0.3813018 g



#View(RR_formatted_F1s$TDW_um)
RR_formatted_F2smaster <- RR_master_F2 %>% 


                              mutate(resp_umol_hr = 
                                    # print the calculate volume adjusted RR when measrued ovl was not avail
                                     case_when(measured_volume %in% NA ~ resp_umol_hr_biovolcalc,
                                    # when measured vol was availabel, simply print the rate present
                                               TRUE ~ resp_umol_hr)) %>% 
  

                              mutate(resp_mg_hr = 
                                    # print the calculate volume adjusted RR when measrued ovl was not avail
                                     case_when(measured_volume %in% NA ~ resp_mg_hr_biovolcalc,
                                    # when measured vol was availabel, simply print the rate present
                                               TRUE ~ resp_mg_hr)) %>% 
  
                              # TDW b factor - to mean TDW or 0.1g
                              dplyr::mutate(
                                            
                                            
                                            resp_mg_hr_bFactorNormTDW.1g = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_mg_hr)*((1/Dry_Tissue_weight)^bTDW.low),
                                                pH  == 7.5 ~ (resp_mg_hr)*((1/Dry_Tissue_weight)^bTDW.mod),
                                                pH  == 7.0 ~ (resp_mg_hr)*((1/Dry_Tissue_weight)^bTDW.high)
                                              ), 
                                            
                                            resp_umol_hr_bFactorNormTDW.MEAN_all = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((F2_meanTDW_all/Dry_Tissue_weight)^bTDW.low),
                                                pH  == 7.5 ~ (resp_umol_hr)*((F2_meanTDW_all/Dry_Tissue_weight)^bTDW.mod),
                                                pH  == 7.0 ~ (resp_umol_hr)*((F2_meanTDW_all/Dry_Tissue_weight)^bTDW.high)
                                              ),                                            
                                            
                                            resp_umol_hr_bFactorNormTDW.MEAN_LvM = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((F2_meanTDW_LvM/Dry_Tissue_weight)^bTDW.low),
                                                pH  == 7.5 ~ (resp_umol_hr)*((F2_meanTDW_LvM/Dry_Tissue_weight)^bTDW.mod),
                                                pH  == 7.0 ~ NA
                                              ),                                            
                                            
                                            
                                            resp_umol_hr_bFactorNormTDW.MEAN_LvH = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((F2_meanTDW_LvH/Dry_Tissue_weight)^bTDW.low),
                                                pH  == 7.5 ~ NA,
                                                pH  == 7.0 ~ (resp_umol_hr)*((F2_meanTDW_LvH/Dry_Tissue_weight)^bTDW.high)
                                              ),
                                            
                                            
                                            
                                            
                                            
                                            
                                            resp_mg_hr_bFactorNormLength.MEAN = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_mg_hr)*((F2_meanLength_all/Length_mm)^bLength.low),
                                                pH  == 7.5 ~ (resp_mg_hr)*((F2_meanLength_all/Length_mm)^bLength.mod),
                                                pH  == 7.0 ~ (resp_mg_hr)*((F2_meanLength_all/Length_mm)^bLength.high)
                                              ), 
                                            
                                            
                                            resp_umol_hr_bFactorNormLength.MEAN_all = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((F2_meanLength_all/Length_mm)^bLength.low),
                                                pH  == 7.5 ~ (resp_umol_hr)*((F2_meanLength_all/Length_mm)^bLength.mod),
                                                pH  == 7.0 ~ (resp_umol_hr)*((F2_meanLength_all/Length_mm)^bLength.high)
                                              ),
                                            
                                            resp_umol_hr_bFactorNormLength.MEAN_LvM = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((F2_meanLength_LvM/Length_mm)^bLength.low),
                                                pH  == 7.5 ~ (resp_umol_hr)*((F2_meanLength_LvM/Length_mm)^bLength.mod),
                                                pH  == 7.0 ~ NA
                                              ),                                            
                                            
                                            resp_umol_hr_bFactorNormLength.MEAN_LvH = 
                                              case_when(
                                                pH  == 8.0 ~ (resp_umol_hr)*((F2_meanLength_LvH/Length_mm)^bLength.low.LvH), # special case
                                                pH  == 7.5 ~ NA,
                                                pH  == 7.0 ~ (resp_umol_hr)*((F2_meanLength_LvH/Length_mm)^bLength.high)
                                              ),                                            
                                            
                                            ) %>% 
                              
                              
                              dplyr::select(c(Gen,
                                              Age,
                                              Date,
                                              pH,
                                              pCO2,
                                              Replicate,
                                              Chamber_tank,
                                              Number,
                                              Run,
                                              Channel,
                                              filetype,
                                              Filename,
                                              Food,
                                              Length_um,
                                              Length_mm,
                                              Dry_Shell_weight,
                                              Dry_Tissue_weight,
                                              whole_Dry_weight,
                                              volume,
                                              Biovolume_g_in_sw,
                                              measured_volume, # as vessel volume - meausred biovolume (NAs where note measured)
                                              Biovol_length3,
                                              calculated_volume, # as vessel volume - (biovol calc from length^3)
                                              Lpc,
                                              BLANK.mean_Lpc,
                                              resp_blankStand,
                                              resp_mg_hr_biovolcalc,
                                              resp_umol_hr_biovolcalc,
                                              resp_mg_hr,
                                              resp_umol_hr,
                                              
                                              resp_mg_hr_bFactorNormTDW.1g,
                                              resp_umol_hr_bFactorNormTDW.MEAN_all, 
                                              resp_umol_hr_bFactorNormTDW.MEAN_LvM,
                                              resp_umol_hr_bFactorNormTDW.MEAN_LvH,
                                              
                                              resp_umol_hr_bFactorNormLength.MEAN_all,
                                              resp_umol_hr_bFactorNormLength.MEAN_LvM,
                                              resp_umol_hr_bFactorNormLength.MEAN_LvH))
#View(RR_formatted_F1smaster)
write.csv(RR_formatted_F2smaster, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/F2/F2_RR_calc_master.csv")
write.csv(RR_formatted_F2smaster, "C:/Users/samuel.gurr/Documents/Github_repositories/EAD-ASEB-Airradians_multigen_OA/RAnalysis/Output/Respiration/F2/F2_RR_calc_master.csv")

```


# F3s master file

-   calculate RR rates with b factor and my mean tissue and mean shell length

```{r, RR_formatted_F3smaster}

# call all bfactors (calc above!) - these are using ALL DATA 
bTDW = 0.704 # review the outlier-omitted b factor plot in previous chunk
bLength = 1.86 # previously 1.71) # review the outlier-omitted b factor plot in previous chunk

meanLength <- mean(RR_master_F3$Length_um/1000) # 1.607371 mm

#View(RR_formatted_F1s$TDW_um)
RR_formatted_F3smaster <- RR_master_F3 %>% 
  
                              mutate(resp_umol_hr = 
                                    # print the calculate volume adjusted RR when measrued ovl was not avail
                                     case_when(measured_volume %in% NA ~ resp_umol_hr_biovolcalc,
                                    # when measured vol was availabel, simply print the rate present
                                               TRUE ~ resp_umol_hr)) %>% 
  

                              mutate(resp_mg_hr = 
                                    # print the calculate volume adjusted RR when measrued ovl was not avail
                                     case_when(measured_volume %in% NA ~ resp_mg_hr_biovolcalc,
                                    # when measured vol was availabel, simply print the rate present
                                               TRUE ~ resp_mg_hr)) %>%                             
                            # TDW b factor - using 'resp_umol_hr'
                            
                            dplyr::mutate(resp_mg_hr_bFactorNormTDW.MEAN = NA) %>% # TDW b factor 
                            
                            dplyr::mutate(resp_mg_hr_bFactorNormTDW.1g = NA) %>% # TDW b factor 
                            
                            dplyr::mutate(resp_umol_hr_bFactorNormTDW.MEAN = NA) %>% # TDW b factor 
                            
                            dplyr::mutate(resp_umol_hr_bFactorNormTDW.1g = NA) %>% # TDW b factor 
                            
                            # Length b factor
                            dplyr::mutate(resp_mg_hr_bFactorNormLength.MEAN = 
                                              (resp_mg_hr)*((meanLength/Length_mm)^bLength) ) %>% # length b factor 
                            
                            dplyr::mutate(resp_umol_hr_bFactorNormLength.MEAN = 
                                              (resp_umol_hr)*((meanLength/Length_mm)^bLength) ) %>% # length b factor 
                            
                            
                            dplyr::select(c(Gen,
                                            Age,
                                            Date,
                                            pH,
                                            pCO2,
                                            Replicate,
                                            Chamber_tank,
                                            Number,
                                            Run,
                                            Channel,
                                            filetype,
                                            Filename,
                                            Food,
                                            Length_um,
                                            Length_mm,
                                            Dry_Shell_weight,
                                            Dry_Tissue_weight,
                                            whole_Dry_weight,
                                            volume,
                                            Biovolume_g_in_sw,
                                            measured_volume, # as vessel volume - meausred biovolume (NAs where note measured)
                                            Biovol_length3,
                                            calculated_volume, # as vessel volume - (biovol calc from length^3)
                                            Lpc,
                                            BLANK.mean_Lpc,
                                            resp_blankStand,
                                            resp_mg_hr, 
                                            resp_mg_hr_biovolcalc,
                                            resp_mg_hr_bFactorNormTDW.MEAN, 
                                            resp_mg_hr_bFactorNormTDW.1g,
                                            resp_mg_hr_bFactorNormLength.MEAN,
                                            resp_umol_hr,
                                            resp_umol_hr_biovolcalc,
                                            resp_umol_hr_bFactorNormTDW.MEAN,
                                            resp_umol_hr_bFactorNormTDW.1g,
                                            resp_umol_hr_bFactorNormLength.MEAN))
#View(RR_formatted_F1smaster)
write.csv(RR_formatted_F3smaster, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/F3/F3_RR_calc_master.csv")
```

